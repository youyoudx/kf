<html>
  dddd
</html>
<script>
var extensionId = 'oobpjdfjeogiipeegcganhgbnpndnodi';
var ws = new WebSocket('ws://localhost:8001');
if(window.WebSocket){
  ws.onopen = function(e){
    console.log("连接服务器成功");
    // 向服务器发送消息
    ws.send("what`s your name?");
  }
  ws.onclose = function(e){
    console.log("服务器关闭");
  }
  ws.onerror = function(){
    console.log("连接出错");
  }
  // 接收服务器的消息
  ws.onmessage = function(e){
    if(e.data != "end"){
      
      var message = e.data.split('||');
      console.log(message);
      if(message[0] == 'publicKey'){
        console.log(message[1]);
        chrome.runtime.sendMessage(extensionId,{ 
          event: 'publicKey',
          data: JSON.parse(message[1]),
        },(hdPath)=>{
          console.log("res data",hdPath);
          //ws.send("hdPath||"+hdPath)
        });
      }else if(message[0] == 'signTransaction'){
        console.log(message[1]);
       // window.opener.postMessage(message[1],'*');

        chrome.runtime.sendMessage(extensionId, {
          event: 'signTransaction',
          data: JSON.parse(message[1]),
        },(hdPath)=>{
          console.log("res data",hdPath);
        });
        // chrome.runtime.sendMessage(extensionId, {
        //   event: 'sinTransactionResult',
        //   data: JSON.parse(message[1]),
        // },(data)=>{
         
        // });    
      }else{
        
        chrome.runtime.sendMessage(extensionId, {
          event: 'connect',
          data: undefined,
        },(hdPath)=>{
          console.log("res data",hdPath);
          ws.send("hdPath||"+hdPath)
        });
      }

    }else{
      console.log("end");
    }
   
  }   
}
window.onload = function() {
  window.addEventListener('message', function(event) {
    //可以通过event.origin  判断消息来源
    console.log(event.data,'a发送来的消息');
    let data = JSON.parse(event.data);
    
    if (data.name == "signTransaction"){
      let hdPath,tx;
      hdPath = data.hdPath;
      tx = data.tx;
      ws.send('signTransaction||{"hdPath":"'+data.hdPath+'","tx":"'+tx+'"}');
    }else if(data.name == "debug"){
      console.log("debug",data);
    }
      
    
    //如果a页面没有关闭
    if(window.opener){
        window.opener.postMessage('我是b，我收到消息了','*');
    }else{
      console.log("a页面关闭了啊");
    }
  
  });
}
 
//window.close();

</script>